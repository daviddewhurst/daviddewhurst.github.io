<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripartite contractual arrangement</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-color: #e2e8f0;
            --c-producer: #10b981;
            --c-insurer: #3b82f6;
            --c-arb: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            height: 100%;
        }

        /* Controls Panel */
        .controls {
            flex: 1;
            min-width: 320px;
            background: var(--panel-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
        }

        input[type=range] { width: 100%; cursor: pointer; }
        .value-display { color: var(--text-color); font-family: monospace; }

        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-top: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
            font-weight: bold;
        }

        /* Scenario Selector Styles */
        select {
            background-color: #334155;
            color: white;
            border: 1px solid #475569;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        /* Tooltip Styles */
        .tooltip-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .info-icon {
            background: #475569;
            color: #e2e8f0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #020617;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            top: 125%;
            left: 50%;
            margin-left: -125px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
            font-size: 0.8rem;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .info-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Visualization Panel */
        .viz {
            flex: 3;
            min-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        canvas {
            width: 100%;
            height: 450px;
            background: #111827;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: var(--panel-color);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #666;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card.producer { border-color: var(--c-producer); }
        .stat-card.insurer { border-color: var(--c-insurer); }
        .stat-card.arb { border-color: var(--c-arb); }
        
        .stat-title { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; opacity: 0.8; }
        .stat-val { font-size: 1.3rem; font-weight: 700; }
        
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 5px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

    </style>

         <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      extensions: ["tex2jax.js"],
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] },
      tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], displayMath: [ ["$$","$$"], ["\\[", "\\]"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno" },
      TeX: { noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } } },
      messageStyle: "none"
    });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
</head>
<body>

    <div class="container">
        <div class="controls">
            
            <div class="section-title" style="margin-top:0;">Macro Scenario</div>
            <div class="tooltip-container">
                <select id="sel_regime">
                    <option value="independent">Independence</option>
                    <option value="stagflation">Stagflation</option>
                    <option value="hedge">Commodity Supercycle</option>
                </select>
                <div class="info-icon">?
                    <div class="tooltip-text" id="tooltip_content">
                        Loading description...
                    </div>
                </div>
            </div>

            <div class="section-title">Timeline</div>
            <div class="control-group">
                <label>War Start (years from now) <span id="val_t0"></span></label>
                <input type="range" id="in_t0" min="1" max="15" step="1" value="2">
            </div>
            <div class="control-group">
                <label>War duration (years)<span id="val_dt"></span></label>
                <input type="range" id="in_dt" min="0" max="10" step="1" value="2">
            </div>

            <div class="section-title">Rates</div>
            <div class="control-group">
                <label>Peace Rate <span id="val_rpre"></span></label>
                <input type="range" id="in_rpre" min="0.0" max="0.15" step="0.001" value="0.045">
            </div>
            <div class="control-group">
                <label>War Rate <span id="val_rpost"></span></label>
                <input type="range" id="in_rpost" min="0.0" max="0.30" step="0.001" value="0.02">
            </div>

            <div class="section-title">Economics</div>
            <div class="control-group">
                <label>Final payoff (π_F) <span id="val_piF"></span></label>
                <input type="range" id="in_piF" min="1000" max="50000" step="1000" value="20000">
            </div>
            <div class="control-group">
                <label>Period cost (C_t) <span id="val_C"></span></label>
                <input type="range" id="in_C" min="10" max="500" step="10" value="100">
            </div>
            <div class="control-group">
                <label>Revenue margin (R/C) <span id="val_margin"></span></label>
                <input type="range" id="in_margin" min="1.0" max="2.0" step="0.01" value="1.15">
            </div>

            <div class="section-title">Structure</div>
            <div class="control-group">
                <label>Payout to insurer<span id="val_K"></span></label>
                <input type="range" id="in_K" min="0" max="10000" step="100" value="2000">
            </div>
            <div class="control-group">
                <label>Equity fraction (f) <span id="val_f"></span></label>
                <input type="range" id="in_f" min="0.0" max="1.0" step="0.05" value="0.5">
            </div>
        </div>

        <div class="viz">
            <div class="stats-row">
                <div class="stat-card producer">
                    <div class="stat-title">Producer</div>
                    <div class="stat-val" id="stat_prod">...</div>
                </div>
                <div class="stat-card insurer">
                    <div class="stat-title">Insurer</div>
                    <div class="stat-val" id="stat_ins">...</div>
                </div>
                <div class="stat-card arb">
                    <div class="stat-title">Speculator</div>
                    <div class="stat-val" id="stat_arb">...</div>
                </div>
            </div>

            <div style="flex:1; position: relative;">
                <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--c-producer)"></div>Producer</div>
                    <div class="legend-item"><div class="dot" style="background:var(--c-insurer)"></div>Insurer</div>
                    <div class="legend-item"><div class="dot" style="background:var(--c-arb)"></div>Speculator</div>
                </div>
                <canvas id="simCanvas"></canvas>
            </div>
        </div>
    </div>

<script>

// --- MATH HELPERS ---

function gaussian() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random(); 
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function poisson(lambda) {
    const L = Math.exp(-lambda);
    let k = 0;
    let p = 1;
    do { k++; p *= Math.random(); } while (p > L);
    return k - 1;
}

class Correlator {
    constructor(regime) {
        this.L = [[1,0,0], [0,1,0], [0,0,1]];

        if (regime === 'stagflation') {
            this.L = [
                [1.0,  0.0,   0.0],
                [0.7,  0.714, 0.0],
                [-0.3, -0.266, 0.916] 
            ];
        } else if (regime === 'hedge') {
            this.L = [
                [1.0, 0.0, 0.0],
                [0.0, 1.0, 0.0],
                [0.8, 0.0, 0.6]
            ];
        }
    }

    transform(z1, z2, z3) {
        const x1 = this.L[0][0]*z1;
        const x2 = this.L[1][0]*z1 + this.L[1][1]*z2;
        const x3 = this.L[2][0]*z1 + this.L[2][1]*z2 + this.L[2][2]*z3;
        return [x1, x2, x3];
    }
}

class WarFinanceSimulation {
    constructor(config) {
        this.cfg = config;
        this.correlator = new Correlator(config.regime);
        
        this.sigma_C = config.mu_C * 0.20; 
        this.sigma_piF = config.mu_piF * 0.30; 
        this.sigma_K = config.mu_K * 0.15; 
        this.sigma_r_pre = 0.005;
        this.sigma_r_post = 0.025; 
        this.sigma_rF = 0.005;
    }

    runPath() {
        const c = this.cfg;
        
        const zC = gaussian();
        const zR = gaussian();
        const zPi = gaussian();
        
        const drivers = this.correlator.transform(zC, zR, zPi);
        
        const path_Mean_C = c.mu_C + (drivers[0] * this.sigma_C); 
        const path_Mean_RPost = Math.max(0, c.mu_r_post + (drivers[1] * this.sigma_r_post)); 
        const path_Val_PiF = c.mu_piF + (drivers[2] * this.sigma_piF); 
        
        const t0 = Math.max(1, poisson(c.lambda_t0));
        const dt = Math.max(0, poisson(c.lambda_dt));
        const t1 = t0 + dt; 

        let sum_P1_Net = 0, sum_P1_Rev = 0;
        let sum_P2_Net = 0, sum_P2_Rev = 0;
        let currentDF = 1.0;
        let df_at_t0 = 0;

        for (let t = 1; t < t1; t++) {
            const isPeace = t < t0;
            
            let rt;
            if (isPeace) {
                rt = Math.max(0, c.mu_r_pre + gaussian() * this.sigma_r_pre);
            } else {
                rt = Math.max(0, path_Mean_RPost + gaussian() * 0.005); 
            }
            
            currentDF = currentDF / (1 + rt);
            if (t === t0) df_at_t0 = currentDF;

            const Ct = path_Mean_C + gaussian() * (c.mu_C * 0.05); 
            const Rt = Ct * c.margin; // Margin slider used here

            if (isPeace) {
                sum_P1_Net += (Rt - Ct) * currentDF;
                sum_P1_Rev += Rt * currentDF;
            } else {
                sum_P2_Net += (Rt - Ct) * currentDF;
                sum_P2_Rev += Rt * currentDF;
            }
        }
        if (df_at_t0 === 0 && t1 >= t0) df_at_t0 = currentDF; 

        const K_val = c.mu_K + gaussian() * this.sigma_K; 
        const pv_K = K_val * df_at_t0;

        const r_F = Math.max(0, 0.025 + gaussian() * 0.002);
        const df_at_t1 = currentDF / (1 + r_F);
        const pv_piF = path_Val_PiF * df_at_t1;

        const pi_Producer = sum_P1_Net + sum_P2_Net + ((1 - c.f) * pv_piF);
        const pi_Insurer = pv_K - sum_P1_Rev;
        const pi_Arb = (c.f * pv_piF) - pv_K - sum_P2_Rev;

        return { prod: pi_Producer, ins: pi_Insurer, arb: pi_Arb };
    }

    simulate(iterations = 15000) {
        const res_prod = new Float32Array(iterations);
        const res_ins = new Float32Array(iterations);
        const res_arb = new Float32Array(iterations);
        let s1=0, s2=0, s3=0;

        for (let i = 0; i < iterations; i++) {
            const p = this.runPath();
            res_prod[i] = p.prod;
            res_ins[i] = p.ins;
            res_arb[i] = p.arb;
            s1+=p.prod; s2+=p.ins; s3+=p.arb;
        }

        return {
            arrays: [res_prod, res_ins, res_arb],
            means: [s1/iterations, s2/iterations, s3/iterations]
        };
    }
}

// --- UI Logic ---
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const regimeSel = document.getElementById('sel_regime');
const tooltip = document.getElementById('tooltip_content');

const inputs = {
    t0: document.getElementById('in_t0'),
    dt: document.getElementById('in_dt'),
    rpre: document.getElementById('in_rpre'),
    rpost: document.getElementById('in_rpost'),
    piF: document.getElementById('in_piF'),
    C: document.getElementById('in_C'),
    margin: document.getElementById('in_margin'),
    K: document.getElementById('in_K'),
    f: document.getElementById('in_f')
};

const displays = {
    t0: document.getElementById('val_t0'),
    dt: document.getElementById('val_dt'),
    rpre: document.getElementById('val_rpre'),
    rpost: document.getElementById('val_rpost'),
    piF: document.getElementById('val_piF'),
    C: document.getElementById('val_C'),
    margin: document.getElementById('val_margin'),
    K: document.getElementById('val_K'),
    f: document.getElementById('val_f')
};

const stats = {
    prod: document.getElementById('stat_prod'),
    ins: document.getElementById('stat_ins'),
    arb: document.getElementById('stat_arb'),
};

const tooltips = {
    independent: "<b>Independence:</b><br>All random variables are uncorrelated. High inflation does not imply high interest rates or low asset values. This is the 'naive' baseline.",
    stagflation: "<b>Stagflation:</b><br>• Costs & rates are positively correlated (+0.7).<br>• Rates & payoff are negatively correlated (-0.4).<br><i>Simulates a war causing supply shocks, forcing rates up, depressing asset value.</i>",
    hedge: "<b>Commodity supercycle:</b><br>• Costs & payoff are positively correlated (+0.8).<br><i>Simulates a scenario where high input costs (inflation) mean the final product is also worth significantly more.</i>"
};

function update() {
    const reg = regimeSel.value;
    tooltip.innerHTML = tooltips[reg];

    const config = {
        regime: reg,
        lambda_t0: parseFloat(inputs.t0.value),
        lambda_dt: parseFloat(inputs.dt.value),
        mu_r_pre: parseFloat(inputs.rpre.value),
        mu_r_post: parseFloat(inputs.rpost.value),
        mu_piF: parseFloat(inputs.piF.value),
        mu_C: parseFloat(inputs.C.value),
        margin: parseFloat(inputs.margin.value),
        mu_K: parseFloat(inputs.K.value),
        f: parseFloat(inputs.f.value)
    };

    // Displays
    displays.t0.innerText = config.lambda_t0;
    displays.dt.innerText = config.lambda_dt;
    displays.rpre.innerText = `${(config.mu_r_pre*100).toFixed(1)}%`;
    displays.rpost.innerText = `${(config.mu_r_post*100).toFixed(1)}%`;
    displays.piF.innerText = `$${config.mu_piF.toLocaleString()}`;
    displays.C.innerText = `$${config.mu_C}`;
    displays.margin.innerText = `${((config.margin-1)*100).toFixed(0)}%`;
    displays.K.innerText = `$${config.mu_K.toLocaleString()}`;
    displays.f.innerText = `${(config.f*100).toFixed(0)}%`;

    // Sim
    const engine = new WarFinanceSimulation(config);
    const results = engine.simulate(15000);

    // Stats
    const fmt = (n) => `$${n.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    stats.prod.innerText = fmt(results.means[0]);
    stats.ins.innerText = fmt(results.means[1]);
    stats.arb.innerText = fmt(results.means[2]);

    // Draw
    drawMultiHistogram(results.arrays);
}

function drawMultiHistogram(arrays) {
    const width = canvas.width = canvas.parentElement.offsetWidth;
    const height = canvas.height = 450;
    ctx.clearRect(0, 0, width, height);

    let minX = Infinity, maxX = -Infinity;
    for(let arr of arrays) {
        for(let i=0; i<arr.length; i+=50) {
            if(arr[i] < minX) minX = arr[i];
            if(arr[i] > maxX) maxX = arr[i];
        }
    }
    const range = maxX - minX;
    minX -= range * 0.1; maxX += range * 0.1;
    if(range===0) { minX = -100; maxX=100; }

    const binCount = 70;
    const binWidth = (maxX - minX) / binCount;

    const getBins = (data) => {
        const bins = new Array(binCount).fill(0);
        for(let val of data) {
            if(val >= minX && val <= maxX) {
                const idx = Math.floor((val - minX) / binWidth);
                if(idx >= 0 && idx < binCount) bins[idx]++;
            }
        }
        return bins;
    };

    const binsProd = getBins(arrays[0]);
    const binsIns = getBins(arrays[1]);
    const binsArb = getBins(arrays[2]);

    let maxBinH = 0;
    [binsProd, binsIns, binsArb].forEach(b => {
        const m = Math.max(...b);
        if(m > maxBinH) maxBinH = m;
    });

    const drawSeries = (bins, color) => {
        ctx.fillStyle = color;
        const barW = width / binCount;
        for(let i=0; i<binCount; i++) {
            const h = (bins[i] / maxBinH) * (height * 0.9);
            const x = i * barW;
            const y = height - h;
            ctx.fillRect(x, y, barW+0.5, h);
        }
    };

    const zeroX = ((0 - minX) / (maxX - minX)) * width;
    if(zeroX > 0 && zeroX < width) {
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(zeroX, 0);
        ctx.lineTo(zeroX, height);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    ctx.globalAlpha = 0.6;
    drawSeries(binsProd, '#10b981'); 
    drawSeries(binsIns, '#3b82f6');
    drawSeries(binsArb, '#f59e0b');
    ctx.globalAlpha = 1.0;
}

Object.values(inputs).forEach(el => el.addEventListener('input', update));
regimeSel.addEventListener('change', update);
window.addEventListener('resize', update);
update();

</script>
</body>
</html>